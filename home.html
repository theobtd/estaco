<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estaco - Home Feed</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }
    #post-form {
      margin-bottom: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    #post-content, #post-photo {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
    }
    #post-button {
      background-color: #4CAF50;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #feed {
      margin-top: 20px;
    }
    .post {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    #error-message {
      color: red;
    }
    .post-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .post-author-picture {
      width: 40px;
      height: 40px;
      border-radius: 15%;
      margin-right: 10px;
    }
    .reactions {
      margin-top: 10px;
    }
    .reaction-button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      margin-right: 5px;
    }
    .reaction-count {
      font-size: 12px;
      margin-left: 3px;
      color: #666;
    }
    .reaction-button.selected {
      background-color: #f0f0f0;
      border-radius: 4px;
      padding: 2px 4px;
    }
  </style>
</head>
<body>
  <h1>Estaco - Home Feed</h1>

  <button id="profile-button" style="margin-top: 20px;">Go to Profile</button>

  <div id="post-form">
      <h3>Create a Post</h3>
      <textarea id="post-content" placeholder="What's on your mind?" rows="3"></textarea>
      <input type="file" id="post-photo" accept="image/*">
      <button id="post-button">Post</button>
      <p id="error-message"></p>
  </div>
  
  <div id="feed">
    <h3>Your Feed</h3>
    <p>No posts yet. Create one!</p>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
  <script>
    // Your Firebase config (replace with your own)
    const firebaseConfig = {
      apiKey: "AIzaSyB1txjASKb_6VPhKBpQh_Y3hoPHsNWwZ_0",
      authDomain: "estaco-add3c.firebaseapp.com",
      projectId: "estaco-add3c",
      storageBucket: "estaco-add3c.firebasestorage.app",
      messagingSenderId: "876337002297",
      appId: "1:876337002297:web:b410c373bd857bc7cd1ae8"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // DOM elements
    const postContent = document.getElementById('post-content');
    const postPhoto = document.getElementById('post-photo');
    const postButton = document.getElementById('post-button');
    const feed = document.getElementById('feed');
    const errorMessage = document.getElementById('error-message');
    // Navigate to Profile Page
    const profileButton = document.getElementById('profile-button');
    profileButton.addEventListener('click', () => {
        window.location.href = 'profile.html';
    });

    // Check if user is signed in and verified
    auth.onAuthStateChanged((user) => {
      if (!user || !user.emailVerified) {
        alert('Please sign in and verify your email to access the home feed.');
        window.location.href = 'index.html';
      }
    });

    // Create a new post
    postButton.addEventListener('click', () => {
      const content = postContent.value;
      const photoFile = postPhoto.files[0];
    
      if (!content) {
        errorMessage.textContent = 'Post content cannot be empty.';
        return;
      }
    
      const user = auth.currentUser;
      user.reload().then(() => {
        const authorName = user.displayName || "Unknown User";
        const post = {
          authorId: user.uid,
          authorName: authorName,
          content: content,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          reactions: {}
        };
    
        // Upload post to Firestore
        db.collection('posts').add(post)
          .then((docRef) => {
            if (photoFile) {
              // Upload photo to Firebase Storage
              const storageRef = storage.ref();
              const photoRef = storageRef.child(`postPhotos/${docRef.id}`);
              const uploadTask = photoRef.put(photoFile);
    
              uploadTask.on('state_changed',
                null,
                (error) => {
                  console.error('Upload error:', error);
                  errorMessage.textContent = 'Failed to upload photo.';
                },
                () => {
                  // Upload complete, get the download URL
                  uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                    // Update the post with the photo URL
                    db.collection('posts').doc(docRef.id).update({ photoURL: downloadURL })
                      .then(() => {
                        alert('Post created!');
                        postContent.value = '';
                        postPhoto.value = '';
                        loadPosts(); // Reload posts after photo URL is updated
                      });
                  });
                }
              );
            } else {
              // No photo, just reload posts
              alert('Post created!');
              postContent.value = '';
              postPhoto.value = '';
              loadPosts();
            }
          })
          .catch((error) => {
            errorMessage.textContent = error.message;
          });
      });
    });

    // Load posts from Firestore
    function loadPosts() {
      db.collection('posts')
        .orderBy('timestamp', 'desc')
        .get()
        .then((querySnapshot) => {
          feed.innerHTML = '<h3>Your Feed</h3>';
          if (querySnapshot.empty) {
            feed.innerHTML += '<p>No posts yet. Create one!</p>';
          } else {
            querySnapshot.forEach((doc) => {
              const post = doc.data();
              // Fetch author's profile picture
              db.collection('users').doc(post.authorId).get()
                .then((userDoc) => {
                  let userData = userDoc.data();
                  let profilePictureURL = userData && userData.profilePictureURL ? userData.profilePictureURL : null;
                  let profilePictureHTML = profilePictureURL
                    ? `<img src="${profilePictureURL}" alt="Profile Picture" class="post-author-picture">`
                    : getInitialsFallback(post.authorName);

                  // Get the current user's reaction for this post
                  const userReaction = post.reactions && post.reactions[auth.currentUser.uid];
                  
                  // Generate reaction buttons, highlighting the user's reaction
                  let likeClass = userReaction === 'like' ? 'selected' : '';
                  let loveClass = userReaction === 'love' ? 'selected' : '';
                  let laughClass = userReaction === 'laugh' ? 'selected' : '';
                  
                  // Count reactions
                  const reactions = post.reactions || {};
                  let likeCount = 0, loveCount = 0, laughCount = 0;
                  Object.values(reactions).forEach(reaction => {
                    if (reaction === 'like') likeCount++;
                    if (reaction === 'love') loveCount++;
                    if (reaction === 'laugh') laughCount++;
                  });
                  
                  // Only show counts if the current user is the author
                  const isAuthor = auth.currentUser && auth.currentUser.uid === post.authorId;
                  const likeCountHTML = isAuthor ? `<span class="reaction-count">${likeCount}</span>` : '';
                  const loveCountHTML = isAuthor ? `<span class="reaction-count">${loveCount}</span>` : '';
                  const laughCountHTML = isAuthor ? `<span class="reaction-count">${laughCount}</span>` : '';
                  
                  let postHTML = `
                    <div class="post">
                      <div class="post-header">
                        ${profilePictureHTML}
                        <h4>${post.authorName}</h4>
                      </div>
                      <p>${post.content}</p>
                      ${post.photoURL ? `<img src="${post.photoURL}" style="max-width: 100%; margin-top: 10px;">` : ''}
                      <div class="reactions">
                        <button class="reaction-button ${likeClass}" data-post-id="${doc.id}" data-reaction="like">üëç${likeCountHTML}</button>
                        <button class="reaction-button ${loveClass}" data-post-id="${doc.id}" data-reaction="love">‚ù§Ô∏è${loveCountHTML}</button>
                        <button class="reaction-button ${laughClass}" data-post-id="${doc.id}" data-reaction="laugh">üòÇ${laughCountHTML}</button>
                      </div>
                    </div>
                  `;
                  // After adding the postHTML to the feed
                  feed.innerHTML += postHTML;
                })
                .catch((error) => {
                  console.error('Error fetching user data:', error);
                  // Get the current user's reaction for this post
                  const userReaction = post.reactions && post.reactions[auth.currentUser.uid];
                  
                  // Generate reaction buttons, highlighting the user's reaction
                  let likeClass = userReaction === 'like' ? 'selected' : '';
                  let loveClass = userReaction === 'love' ? 'selected' : '';
                  let laughClass = userReaction === 'laugh' ? 'selected' : '';
                  
                  let postHTML = `
                    <div class="post">
                      <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        ${getInitialsFallback(post.authorName)}
                        <h4>${post.authorName}</h4>
                      </div>
                      <p>${post.content}</p>
                      ${post.photoURL ? `<img src="${post.photoURL}" style="max-width: 100%; margin-top: 10px;">` : ''}
                      <div class="reactions">
                        <button class="reaction-button ${likeClass}" data-post-id="${doc.id}" data-reaction="like">üëç</button>
                        <button class="reaction-button ${loveClass}" data-post-id="${doc.id}" data-reaction="love">‚ù§Ô∏è</button>
                        <button class="reaction-button ${laughClass}" data-post-id="${doc.id}" data-reaction="laugh">üòÇ</button>
                      </div>
                    </div>
                  `;
                  feed.innerHTML += postHTML;
                });
            });
          }
        })
        .catch((error) => {
          errorMessage.textContent = error.message;
        });
    }

    function getInitialsFallback(name) {
      const firstLetter = name.charAt(0).toUpperCase();
      const pastelColors = ['#FFD1DC', '#FFE4B5', '#B5EAD7', '#C7CEEA', '#E2F0CB', '#FFB7B2'];
      const colorIndex = name.charCodeAt(0) % pastelColors.length;
      const backgroundColor = pastelColors[colorIndex];
      return `
        <div style="
          width: 40px;
          height: 40px;
          border-radius: 15%;
          background-color: ${backgroundColor};
          display: flex;
          align-items: center;
          justify-content: center;
          color: #333;
          font-weight: bold;
          font-size: 20px;
          margin-right: 10px;
        ">
          ${firstLetter}
        </div>
      `;
    }

    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('reaction-button')) {
        const button = e.target;
        const postId = button.getAttribute('data-post-id');
        const reaction = button.getAttribute('data-reaction');
        const user = auth.currentUser;
        if (!user) return;
    
        // Optimistic UI update: Assume success
        const postRef = db.collection('posts').doc(postId);
        const wasSelected = button.classList.contains('selected');
        const countEl = document.getElementById(`reaction-count-${postId}`);
    
        // Toggle the selected class
        const likeButton = document.querySelector(`.reaction-button[data-post-id="${postId}"][data-reaction="like"]`);
        const loveButton = document.querySelector(`.reaction-button[data-post-id="${postId}"][data-reaction="love"]`);
        const laughButton = document.querySelector(`.reaction-button[data-post-id="${postId}"][data-reaction="laugh"]`);
    
        // Reset all buttons
        if (likeButton) likeButton.classList.remove('selected');
        if (loveButton) loveButton.classList.remove('selected');
        if (laughButton) laughButton.classList.remove('selected');
    
        // Select the clicked button (unless it was already selected)
        if (!wasSelected) {
          button.classList.add('selected');
        }
    
        // Optimistic count update
        if (countEl) {
          const counts = countEl.textContent.match(/(\d+) likes, (\d+) loves, (\d+) laughs/);
          let likeCount = counts ? parseInt(counts[1]) : 0;
          let loveCount = counts ? parseInt(counts[2]) : 0;
          let laughCount = counts ? parseInt(counts[3]) : 0;
        
          // Get the previous reaction (if any)
          const prevReaction = Array.from(document.querySelectorAll(`.reaction-button[data-post-id="${postId}"].selected`))
            .map(btn => btn.getAttribute('data-reaction'))[0];
        
          // If there was a previous reaction, decrement its count
          if (prevReaction) {
            if (prevReaction === 'like') likeCount--;
            if (prevReaction === 'love') loveCount--;
            if (prevReaction === 'laugh') laughCount--;
          }
        
          // If the clicked button was not selected, increment its count
          if (!wasSelected) {
            if (reaction === 'like') likeCount++;
            if (reaction === 'love') loveCount++;
            if (reaction === 'laugh') laughCount++;
          }
        
          countEl.textContent = `${likeCount} likes, ${loveCount} loves, ${laughCount} laughs`;
        }

    
        // Perform the Firestore transaction
        db.runTransaction((transaction) => {
          return transaction.get(postRef).then((doc) => {
            if (!doc.exists) throw "Post does not exist!";
            const postData = doc.data();
            const reactions = postData.reactions || {};
            const userReaction = reactions[user.uid];
    
            if (userReaction === reaction) {
              delete reactions[user.uid];
            } else {
              reactions[user.uid] = reaction;
            }
    
            transaction.update(postRef, { reactions });
          });
        }).catch((error) => {
          console.error("Transaction failed: ", error);
          // Revert UI on failure
          if (likeButton) likeButton.classList.remove('selected');
          if (loveButton) loveButton.classList.remove('selected');
          if (laughButton) laughButton.classList.remove('selected');
          if (!wasSelected) {
            if (reaction === 'like' && likeButton) likeButton.classList.add('selected');
            if (reaction === 'love' && loveButton) loveButton.classList.add('selected');
            if (reaction === 'laugh' && laughButton) laughButton.classList.add('selected');
          }
          // Revert count
          if (countEl) {
            const counts = countEl.textContent.match(/(\d+) likes, (\d+) loves, (\d+) laughs/);
            let likeCount = counts ? parseInt(counts[1]) : 0;
            let loveCount = counts ? parseInt(counts[2]) : 0;
            let laughCount = counts ? parseInt(counts[3]) : 0;
          
            // If there was a previous reaction, increment its count
            if (prevReaction) {
              if (prevReaction === 'like') likeCount++;
              if (prevReaction === 'love') loveCount++;
              if (prevReaction === 'laugh') laughCount++;
            }
          
            // If the clicked button was not selected, decrement its count
            if (!wasSelected) {
              if (reaction === 'like') likeCount--;
              if (reaction === 'love') loveCount--;
              if (reaction === 'laugh') laughCount--;
            }
          
            countEl.textContent = `${likeCount} likes, ${loveCount} loves, ${laughCount} laughs`;
          }
        });
      }
    });

    // Load posts when page loads
    window.onload = loadPosts;
  </script>
</body>
</html>
