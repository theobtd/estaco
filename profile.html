<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <title>Estaco - Profile</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        .profile-info {
            margin-bottom: 20px;
        }
        .button {
            margin-left: 10px;
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .button:hover {
            background-color: #45a049;
        }
        #error-message {
            color: red;
        }
        #success-message {
            color: green;
        }
        .profile-picture-container {
          display: inline-block;
          position: relative;
        }
        .profile-picture-placeholder {
          width: 100px;
          height: 100px;
          border-radius: 15%;
        }
        .friend-list, .pending-friends {
            margin-top: 20px;
        }
        .friend, .pending-friend {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .friend-button {
            margin-left: 10px;
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .friend-button.remove {
            background-color: #f44336;
        }
        #user-posts-feed {
          margin-top: 30px;
          width: 100%;
        }
        .post {
          padding: 10px;
          border: 1px solid #ddd;
          border-radius: 5px;
          margin-bottom: 10px;
        }
        .post-header {
          display: flex;
          align-items: center;
          margin-bottom: 10px;
        }
        .post-author-picture {
          width: 40px;
          height: 40px;
          border-radius: 15%;
          margin-right: 10px;
        }
        .reactions {
          margin-top: 10px;
        }
        .reaction-button {
          background: none;
          border: none;
          font-size: 20px;
          cursor: pointer;
          margin-right: 5px;
        }
        .reaction-count {
          font-size: 12px;
          margin-left: 3px;
          color: #666;
        }
        .reaction-button.selected {
          background-color: #f0f0f0;
          border-radius: 4px;
          padding: 2px 4px;
        }
        .comments-section {
          margin-top: 10px;
          border-top: 1px solid #eee;
          padding-top: 10px;
        }
        .comment-form {
          display: flex;
          margin-bottom: 10px;
        }
        .comment-input {
          flex: 1;
          padding: 8px;
          border: 1px solid #ddd;
          border-radius: 4px;
        }
        .comment-button {
          padding: 8px 12px;
          background: #4CAF50;
          color: white;
          border: none;
          border-radius: 4px;
          margin-left: 5px;
          cursor: pointer;
        }
        .comment {
          display: flex;
          margin-bottom: 8px;
          align-items: flex-start;
        }
        .comment-author-picture {
          width: 30px;
          height: 30px;
          border-radius: 10%;
          margin-right: 8px;
        }
        .comment-content {
          background: #f9f9f9;
          padding: 8px 12px;
          border-radius: 8px;
          flex: 1;
        }
        .comment-author-name {
          font-weight: bold;
          margin-bottom: 2px;
        }
        .media-container {
          position: relative;
          margin-top: 10px;
          overflow: hidden;
          background-color: #f0f0f0;
        }
        .media-horizontal,
        .media-vertical {
          width: 100%;
          height: auto;
          position: relative;
          overflow: hidden;
          background-color: transparent;
          margin: 0;
        }
        .media-horizontal {
          aspect-ratio: 16 / 9;
        }
        .media-vertical {
          aspect-ratio: 9 / 16;
        }
        .media-container img,
        .media-container video {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          object-fit: cover;
        }
        .custom-play-button {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0, 0, 0, 0.7);
          color: white;
          border: none;
          border-radius: 50%;
          width: 60px;
          height: 60px;
          font-size: 20px;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .custom-play-button.hidden {
          display: none;
        }
        .delete-post-button {
          background: #f44336;
          color: white;
          border: none;
          border-radius: 4px;
          padding: 4px 8px;
          cursor: pointer;
          font-size: 12px;
        }

    </style>
</head>
<body>
    <h1>Your Profile</h1>
    <button id="back-to-home-button" class="button">Back to Home</button>
    <div class="profile-info">
        <div class="profile-picture-container">
          <div id="profile-picture-placeholder" class="profile-picture-placeholder"></div>
          <img id="profile-picture" src="" alt="Profile Picture" style="max-width: 100px; border-radius: 15%; display: none;">
        </div>
        <input type="file" id="update-profile-pic" accept="image/*" style="display: none;">
        <button id="update-profile-pic-button" class="button">Update Profile Picture</button>
        <p><strong>Name:</strong> <span id="user-name"></span></p>
        <p><strong>Email:</strong> <span id="user-email"></span></p>
        <p><strong>Password:</strong> <span id="user-password"></span>
            <button id="change-password-button" class="button">Change Password</button>
        </p>
        <p id="error-message"></p>
        <p id="success-message"></p>
        <button id="logout-button" class="button">Log Out</button>
    </div>

    <!-- Add this inside your <body>, after the profile-info div -->
    <div id="cropper-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
      <div style="max-width: 500px; margin: 20px auto; background: white; padding: 20px; border-radius: 10px;">
        <h3>Crop Profile Picture</h3>
        <div style="width: 100%; height: 400px;">
          <img id="cropper-image" style="max-width: 100%;">
        </div>
        <button id="crop-done-button" class="button" style="margin-top: 10px;">Crop and Upload</button>
        <button id="crop-cancel-button" class="button" style="margin-top: 10px; background-color: #f44336;">Cancel</button>
      </div>
    </div>

    <div class="profile-info">
        <!-- existing profile info content -->
        <h2>Friend System</h2>
        <input type="text" id="search-friend" placeholder="Search by name...">
        <button id="send-friend-request" class="button">Send Friend Request</button>
        
        <div class="pending-friends">
            <h3>Pending Friend Requests</h3>
            <div id="pending-friend-requests"></div>
        </div>

        <div class="friend-list">
            <h3>Current Friends</h3>
            <div id="current-friends"></div>
        </div>
    </div>

    <div id="user-posts-feed">
      <h3>Your Posts</h3>
      <div id="user-posts-container"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script>
        // Your Firebase config (replace with your own)
        const firebaseConfig = {
            apiKey: "AIzaSyB1txjASKb_6VPhKBpQh_Y3hoPHsNWwZ_0",
            authDomain: "estaco-add3c.firebaseapp.com",
            projectId: "estaco-add3c",
            storageBucket: "estaco-add3c.firebasestorage.app",
            messagingSenderId: "876337002297",
            appId: "1:876337002297:web:b410c373bd857bc7cd1ae8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const storage = firebase.storage();
        const db = firebase.firestore();

        // DOM Elements
        const searchFriendInput = document.getElementById('search-friend');
        const sendFriendRequestButton = document.getElementById('send-friend-request');
        const pendingFriendRequestsDiv = document.getElementById('pending-friend-requests');
        const currentFriendsDiv = document.getElementById('current-friends');

        // Load friends and requests on page load
        auth.onAuthStateChanged(user => {
            if (user) {
                loadPendingRequests(user.uid);
                loadCurrentFriends(user.uid);
            }
        });

        // Load pending friend requests
        function loadPendingRequests(userId) {
            db.collection('friendRequests').where('to', '==', userId).get()
                .then(snapshot => {
                    pendingFriendRequestsDiv.innerHTML = '';
                    const promises = [];
                    snapshot.forEach(doc => {
                        const request = doc.data();
                        const promise = db.collection('users').doc(request.from).get()
                            .then(userDoc => {
                                const fromName = userDoc.data().name;
                                const requestDiv = document.createElement('div');
                                requestDiv.className = 'pending-friend';
                                requestDiv.innerText = fromName;
                                const acceptButton = document.createElement('button');
                                acceptButton.className = 'friend-button';
                                acceptButton.innerText = 'Accept';
                                acceptButton.onclick = () => acceptFriendRequest(request.from, userId);
                                requestDiv.appendChild(acceptButton);
                                pendingFriendRequestsDiv.appendChild(requestDiv);
                            });
                        promises.push(promise);
                    });
                    return Promise.all(promises);
                });
        }

        // Load current friends
        function loadCurrentFriends(userId) {
            db.collection('friends').doc(userId).get()
                .then(doc => {
                    const friends = doc.data()?.friends || [];
                    currentFriendsDiv.innerHTML = '';
                    friends.forEach(friend => {
                        const friendDiv = document.createElement('div');
                        friendDiv.className = 'friend';
                        friendDiv.innerText = friend.name;
                        // Add a "Remove" button
                        const removeButton = document.createElement('button');
                        removeButton.className = 'friend-button remove';
                        removeButton.innerText = 'Remove';
                        removeButton.onclick = () => removeFriend(userId, friend.uid);
                        friendDiv.appendChild(removeButton);
                        currentFriendsDiv.appendChild(friendDiv);
                    });
                });
        }

        // Send friend request
        sendFriendRequestButton.addEventListener('click', () => {
            const friendName = searchFriendInput.value.trim();
            if (friendName) {
                console.log(`Searching for user with name: ${friendName}`); // Log the search name
                db.collection('users').where('name', '==', friendName).get()
                    .then(snapshot => {
                        if (!snapshot.empty) {
                            const friendDoc = snapshot.docs[0];
                            const friendUser = friendDoc.data();
                            const friendUid = friendDoc.id; // <-- This is the UID!
                            sendRequest(auth.currentUser.uid, friendUid, friendUser.name);
                        } else {
                            alert('User not found');
                        }
                    })
                    .catch(error => {
                        console.error('Error searching for user: ', error);
                        alert('An error occurred while searching for the user.');
                    });
            } else {
                alert('Please enter a name to search');
            }
        });

        // Function to send friend request
        function sendRequest(fromId, toId, fromName) {
            if (!toId) {
                console.error('Cannot send friend request: toId is undefined.');
                return;
            }
            db.collection('friendRequests').add({
                from: fromId,
                to: toId,
                fromName: fromName,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                alert('Friend request sent!');
            }).catch(error => {
                console.error('Error sending friend request: ', error);
                alert('Failed to send friend request.');
            });
        }

        // Accept friend request
        function acceptFriendRequest(fromId, toId) {
            // Fetch the name of the user sending the request
            db.collection('users').doc(fromId).get()
                .then(fromUserDoc => {
                    const fromName = fromUserDoc.data().name;
                    // Fetch the name of the current user
                    db.collection('users').doc(toId).get()
                        .then(toUserDoc => {
                            const toName = toUserDoc.data().name;
                            // Add the friend to both users' friend lists
                            db.collection('friends').doc(toId).set({
                                friends: firebase.firestore.FieldValue.arrayUnion({ uid: fromId, name: fromName })
                            }, { merge: true });
                            db.collection('friends').doc(fromId).set({
                                friends: firebase.firestore.FieldValue.arrayUnion({ uid: toId, name: toName })
                            }, { merge: true });
                            // Remove the friend request
                            db.collection('friendRequests').where('from', '==', fromId).where('to', '==', toId).get()
                                .then(snapshot => {
                                    snapshot.forEach(doc => {
                                        doc.ref.delete();
                                    });
                                    // Remove the accepted request from the DOM
                                    const pendingRequests = document.querySelectorAll('.pending-friend');
                                    pendingRequests.forEach(requestDiv => {
                                        if (requestDiv.textContent.includes(fromName)) {
                                            requestDiv.remove();
                                        }
                                    });
                                    alert('Friend request accepted!');
                                    loadCurrentFriends(toId);
                                });
                        });
                });
        }

        function removeFriend(userId, friendUid) {
            // Ask for confirmation
            const confirmRemove = confirm("Are you sure you want to remove this friend?");
            if (!confirmRemove) {
                return; // Do nothing if the user cancels
            }
        
            // Fetch the friend's name
            db.collection('users').doc(friendUid).get()
                .then((friendDoc) => {
                    if (friendDoc.exists) {
                        const friendName = friendDoc.data().name;
                        // Remove friend from current user's friend list
                        db.collection('friends').doc(userId).update({
                            friends: firebase.firestore.FieldValue.arrayRemove({ uid: friendUid, name: friendName })
                        });
                        // Remove current user from friend's friend list
                        db.collection('users').doc(userId).get()
                            .then((userDoc) => {
                                const userName = userDoc.data().name;
                                db.collection('friends').doc(friendUid).update({
                                    friends: firebase.firestore.FieldValue.arrayRemove({ uid: userId, name: userName })
                                });
                                // Reload the friend list
                                loadCurrentFriends(userId);
                            });
                    }
                })
                .catch((error) => {
                    console.error("Error removing friend: ", error);
                    alert("Failed to remove friend.");
                });
        }

        // Display user information
        auth.onAuthStateChanged((user) => {
          if (user) {
            document.getElementById('user-name').textContent = user.displayName || "No name set";
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('user-password').textContent = "******";
        
            // Load user data from Firestore
            db.collection('users').doc(user.uid).get()
              .then((doc) => {
                if (doc.exists) {
                  const userData = doc.data();
                  const placeholder = document.getElementById('profile-picture-placeholder');
                  const img = document.getElementById('profile-picture');
                  if (userData.profilePictureURL) {
                    img.src = userData.profilePictureURL;
                    img.onload = function() {
                      placeholder.style.display = 'none';
                      img.style.display = 'block';
                    };
                  } else {
                    // No profile picture, show initials fallback
                    placeholder.innerHTML = getInitialsFallback(user.displayName || "No name set");
                  }
                }
              });
          }
        });
        
        // Upload profile picture
        document.getElementById('update-profile-pic-button').addEventListener('click', () => {
          const fileInput = document.getElementById('update-profile-pic');
          fileInput.click();
        });
        
        let cropper;
        document.getElementById('update-profile-pic').addEventListener('change', (event) => {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              const modal = document.getElementById('cropper-modal');
              const cropperImage = document.getElementById('cropper-image');
              cropperImage.src = e.target.result;
              modal.style.display = 'block';
        
              // Initialize Cropper.js
              cropper = new Cropper(cropperImage, {
                aspectRatio: 1, // Square aspect ratio
                viewMode: 1,
                dragMode: 'move',
                guides: true,
                highlight: false,
                cropBoxMovable: true,
                cropBoxResizable: true,
                modal: true,
              });
            };
            reader.readAsDataURL(file);
          }
        });

        function getInitialsFallback(name) {
          const firstLetter = name.charAt(0).toUpperCase();
          const pastelColors = ['#FFD1DC', '#FFE4B5', '#B5EAD7', '#C7CEEA', '#E2F0CB', '#FFB7B2'];
          const colorIndex = name.charCodeAt(0) % pastelColors.length;
          const backgroundColor = pastelColors[colorIndex];
          return `
            <div style="
              width: 100px;
              height: 100px;
              border-radius: 15%;
              background-color: ${backgroundColor};
              display: flex;
              align-items: center;
              justify-content: center;
              color: #333;
              font-weight: bold;
              font-size: 40px;
              margin-right: 10px;
            ">
              ${firstLetter}
            </div>
          `;
        }
        
        // Handle crop done
        document.getElementById('crop-done-button').addEventListener('click', () => {
          if (cropper) {
            const canvas = cropper.getCroppedCanvas({
              width: 200,
              height: 200,
              fillColor: '#fff',
              imageSmoothingEnabled: true,
              imageSmoothingQuality: 'high',
            });
            if (canvas) {
              canvas.toBlob((blob) => {
                const user = auth.currentUser;
                const storageRef = storage.ref();
                const profilePicRef = storageRef.child(`profilePictures/${user.uid}`);
                const uploadTask = profilePicRef.put(blob);
        
                uploadTask.on('state_changed',
                  null,
                  (error) => {
                    console.error('Upload error:', error);
                    document.getElementById('error-message').textContent = 'Failed to upload profile picture.';
                  },
                  () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                      db.collection('users').doc(user.uid).update({
                        profilePictureURL: downloadURL
                      }).then(() => {
                        document.getElementById('profile-picture').src = downloadURL;
                        document.getElementById('success-message').textContent = 'Profile picture updated!';
                        document.getElementById('cropper-modal').style.display = 'none';
                        cropper.destroy();
                      });
                    });
                  }
                );
              }, 'image/jpeg');
            }
          }
        });
        
        // Handle cancel
        document.getElementById('crop-cancel-button').addEventListener('click', () => {
          document.getElementById('cropper-modal').style.display = 'none';
          if (cropper) {
            cropper.destroy();
          }
        });

        // Change Password
        document.getElementById('change-password-button').addEventListener('click', () => {
            const currentPassword = prompt('Enter your current password:');
            if (currentPassword) {
                const user = auth.currentUser;
                const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
                user.reauthenticateWithCredential(credential).then(() => {
                    const newPassword = prompt('Enter your new password (at least 6 characters):');
                    const confirmPassword = prompt('Confirm your new password:');

                    if (newPassword && confirmPassword && newPassword === confirmPassword && newPassword.length >= 6) {
                        user.updatePassword(newPassword).then(() => {
                            document.getElementById('success-message').textContent = 'Password updated successfully!';
                            document.getElementById('error-message').textContent = '';
                        }).catch((error) => {
                            document.getElementById('error-message').textContent = error.message;
                            document.getElementById('success-message').textContent = '';
                        });
                    } else {
                        alert('Passwords do not match or are too short. Please try again.');
                    }
                }).catch((error) => {
                    document.getElementById('error-message').textContent = 'Current password is incorrect.';
                    document.getElementById('success-message').textContent = '';
                });
            }
        });

        // Back to Home
        document.getElementById('back-to-home-button').addEventListener('click', () => {
            window.location.href = 'home.html';
        });

        // Log Out
        document.getElementById('logout-button').addEventListener('click', () => {
          const confirmLogout = confirm('Are you sure you want to log out?');
          if (confirmLogout) {
            auth.signOut().then(() => {
              alert('You have been logged out.');
              window.location.href = 'index.html';
            }).catch((error) => {
              document.getElementById('error-message').textContent = error.message;
            });
          }
        });

        // Function to load and render the current user's posts
      function loadUserPosts(userId) {
        db.collection('posts')
          .where('authorId', '==', userId)
          .orderBy('timestamp', 'desc')
          .get()
          .then((querySnapshot) => {
            const userPostsContainer = document.getElementById('user-posts-container');
            userPostsContainer.innerHTML = '';
            if (querySnapshot.empty) {
              userPostsContainer.innerHTML = '<p>You have not created any posts yet.</p>';
              return;
            }
            querySnapshot.forEach((doc) => {
              const post = doc.data();
              post.id = doc.id;
              renderUserPost(post);
            });
          })
          .catch((error) => {
            console.error("Error loading user posts: ", error);
            document.getElementById('user-posts-container').innerHTML = '<p>Error loading posts.</p>';
          });
      }
    
      // Function to render a single user post
      function renderUserPost(post) {
        const userPostsContainer = document.getElementById('user-posts-container');
        const profilePictureURL = post.authorData?.profilePictureURL;
        const profilePictureHTML = profilePictureURL
          ? `<img src="${profilePictureURL}" alt="Profile Picture" class="post-author-picture">`
          : getInitialsFallback(post.authorName);
    
        // Get the current user's reaction for this post
        const userReaction = post.reactions && post.reactions[auth.currentUser.uid];
        const likeClass = userReaction === 'like' ? 'selected' : '';
        const loveClass = userReaction === 'love' ? 'selected' : '';
        const laughClass = userReaction === 'laugh' ? 'selected' : '';
    
        const reactions = post.reactions || {};
        let likeCount = 0, loveCount = 0, laughCount = 0;
        Object.values(reactions).forEach(reaction => {
          if (reaction === 'like') likeCount++;
          if (reaction === 'love') loveCount++;
          if (reaction === 'laugh') laughCount++;
        });
    
        let mediaHTML = '';
        if (post.photoURL) {
          const orientation = post.mediaOrientation || 'horizontal';
          mediaHTML = `
            <div class="media-container media-${orientation}">
              <img src="${post.photoURL}" class="post-media">
            </div>
          `;
        } else if (post.videoURL) {
          mediaHTML = `
            <div class="media-container media-vertical">
              <div class="video-wrapper" style="position: relative;">
                <video class="post-media" data-post-id="${post.id}" muted playsinline>
                  <source src="${post.videoURL}" type="video/mp4">
                </video>
                <button class="custom-play-button" data-post-id="${post.id}">‚ñ∂</button>
              </div>
            </div>
          `;
        }
    
        const postHTML = `
          <div class="post" data-post-id="${post.id}">
            <div class="post-header" style="display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center;">
                ${profilePictureHTML}
                <h4 style="margin: 0;">${post.authorName}</h4>
              </div>
              <div style="display: flex; align-items: center;">
                <span style="font-size: 12px; color: #666; margin-right: 10px;">${formatTimestamp(post.timestamp.toDate())}</span>
                <button class="delete-post-button" data-post-id="${post.id}">Delete</button>
              </div>
            </div>
            <p>${post.content}</p>
            ${mediaHTML}
            <div class="reactions">
              <button class="reaction-button ${likeClass}" data-post-id="${post.id}" data-reaction="like">üëç<span class="reaction-count">${likeCount}</span></button>
              <button class="reaction-button ${loveClass}" data-post-id="${post.id}" data-reaction="love">‚ù§Ô∏è<span class="reaction-count">${loveCount}</span></button>
              <button class="reaction-button ${laughClass}" data-post-id="${post.id}" data-reaction="laugh">üòÇ<span class="reaction-count">${laughCount}</span></button>
            </div>
            <div class="comments-section">
              <div class="comment-form">
                <input type="text" class="comment-input" placeholder="Write a comment..." data-post-id="${post.id}">
                <button class="comment-button" data-post-id="${post.id}">Post</button>
              </div>
              <div class="comments-list" id="comments-${post.id}">
                <!-- Comments will be loaded here -->
              </div>
            </div>
          </div>
        `;
        userPostsContainer.innerHTML += postHTML;
    
        // Load comments for this post
        loadUserPostComments(post.id);
      }
    
      // Function to load comments for a user post
      function loadUserPostComments(postId) {
        db.collection('posts').doc(postId).collection('comments')
          .orderBy('timestamp', 'asc')
          .get()
          .then((querySnapshot) => {
            const commentsList = document.getElementById(`comments-${postId}`);
            commentsList.innerHTML = '';
            querySnapshot.forEach((doc) => {
              const comment = doc.data();
              getCommentAuthorPicture(comment.authorId, comment.authorName).then((profilePictureHTML) => {
                const commentHTML = `
                  <div class="comment">
                    <div class="comment-author-picture">
                      ${profilePictureHTML}
                    </div>
                    <div class="comment-content">
                      <div class="comment-author-name">${comment.authorName}</div>
                      <div>${comment.content}</div>
                    </div>
                  </div>
                `;
                commentsList.innerHTML += commentHTML;
              });
            });
          })
          .catch((error) => {
            console.error("Error loading comments: ", error);
          });
      }
    
      // Call loadUserPosts when the page loads and the user is authenticated
      auth.onAuthStateChanged((user) => {
        if (user) {
          loadUserPosts(user.uid);
        }
      });
    
      // Add event listeners for reactions, comments, and post deletion
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('reaction-button')) {
          const button = e.target;
          const postId = button.getAttribute('data-post-id');
          const reaction = button.getAttribute('data-reaction');
          const user = auth.currentUser;
          if (!user) return;
    
          const postRef = db.collection('posts').doc(postId);
          const wasSelected = button.classList.contains('selected');
    
          // Toggle the selected class
          const likeButton = document.querySelector(`.reaction-button[data-post-id="${postId}"][data-reaction="like"]`);
          const loveButton = document.querySelector(`.reaction-button[data-post-id="${postId}"][data-reaction="love"]`);
          const laughButton = document.querySelector(`.reaction-button[data-post-id="${postId}"][data-reaction="laugh"]`);
          if (likeButton) likeButton.classList.remove('selected');
          if (loveButton) loveButton.classList.remove('selected');
          if (laughButton) laughButton.classList.remove('selected');
          if (!wasSelected) {
            button.classList.add('selected');
          }
    
          db.runTransaction((transaction) => {
            return transaction.get(postRef).then((doc) => {
              if (!doc.exists) throw "Post does not exist!";
              const postData = doc.data();
              const reactions = postData.reactions || {};
              const userReaction = reactions[user.uid];
    
              if (userReaction === reaction) {
                delete reactions[user.uid];
              } else {
                reactions[user.uid] = reaction;
              }
    
              transaction.update(postRef, { reactions });
            });
          }).catch((error) => {
            console.error("Transaction failed: ", error);
          });
        } else if (e.target.classList.contains('comment-button')) {
          const postId = e.target.getAttribute('data-post-id');
          const commentInput = document.querySelector(`.comment-input[data-post-id="${postId}"]`);
          const content = commentInput.value.trim();
          if (content) {
            addComment(postId, content);
            commentInput.value = '';
          }
        } else if (e.target.classList.contains('delete-post-button')) {
          const postId = e.target.getAttribute('data-post-id');
          const confirmDelete = confirm('Are you sure you want to delete this post?');
          if (confirmDelete) {
            deletePost(postId);
          }
        } else if (e.target.classList.contains('custom-play-button') || e.target.classList.contains('post-media')) {
          const postId = e.target.getAttribute('data-post-id');
          const video = e.target.classList.contains('post-media')
            ? e.target
            : document.querySelector(`.post-media[data-post-id="${postId}"]`);
          const playButton = document.querySelector(`.custom-play-button[data-post-id="${postId}"]`);
    
          if (video.paused) {
            video.play();
            playButton.classList.add('hidden');
          } else {
            video.pause();
            playButton.classList.remove('hidden');
          }
        }
      });
    
      // Function to add a comment to a user post
      function addComment(postId, content) {
        const user = auth.currentUser;
        if (!user) return;
    
        const comment = {
          authorId: user.uid,
          authorName: user.displayName || "Unknown User",
          content: content,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        };
    
        db.collection('posts').doc(postId).collection('comments').add(comment)
          .then(() => {
            loadUserPostComments(postId);
          })
          .catch((error) => {
            console.error("Error adding comment: ", error);
          });
      }
    
      // Function to delete a user post
      async function deletePost(postId) {
        try {
          const postRef = db.collection('posts').doc(postId);
          const postDoc = await postRef.get();
          if (!postDoc.exists) {
            console.error('Post does not exist');
            return;
          }
    
          const postData = postDoc.data();
          const storage = firebase.storage();
    
          if (postData.photoURL) {
            const photoRef = storage.refFromURL(postData.photoURL);
            await photoRef.delete();
          }
          if (postData.videoURL) {
            const videoRef = storage.refFromURL(postData.videoURL);
            await videoRef.delete();
          }
    
          await postRef.delete();
          const postElement = document.querySelector(`.post[data-post-id="${postId}"]`);
          if (postElement) {
            postElement.remove();
          }
          alert('Post deleted successfully!');
        } catch (error) {
          console.error('Error deleting post:', error);
          alert('Failed to delete post. Please try again.');
        }
      }
    
      // Helper function to format timestamp
      function formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleString();
      }
    </script>
</body>
</html>
