<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <title>Estaco</title>
    <style>
        :root {
          --estaco-primary: #8B8E6F;
          --estaco-primary-light: #A7A98C;
          --estaco-secondary: #E2725B;
          --estaco-accent: #A8B8A8;
          --estaco-background: #FFFFFF;
          --estaco-surface: #F9F9F9;
          --estaco-text: #333333;
          --estaco-text-light: #666666;
          --estaco-border: #E0E0E0;
          --estaco-error: #F44336;
          --estaco-success: #4CAF50;
        }
    
        body {
          font-family: 'Inter', 'Roboto', 'Helvetica Neue', sans-serif;
          margin: 0;
          padding: 0;
          padding-top: 60px;
          padding-bottom: 60px;
          background-color: var(--estaco-background);
          color: var(--estaco-text);
          line-height: 1.5;
        }
    
        #top-nav-bar {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          display: flex;
          justify-content: center;
          align-items: center;
          background-color: var(--estaco-surface);
          border-bottom: 1px solid var(--estaco-border);
          padding: 12px 0;
          z-index: 100;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
    
        #top-nav-bar h1 {
          margin: 0;
          font-size: 20px;
          font-weight: 600;
          color: var(--estaco-primary);
          letter-spacing: 0.5px;
        }
    
        .profile-header {
          background: var(--estaco-surface);
          padding: 24px;
          margin-bottom: 16px;
          border-radius: 12px;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
          display: flex;
          flex-direction: column;
          align-items: center;
          text-align: center;
          border: 1px solid var(--estaco-border);
        }
    
        .profile-picture-container {
          margin-bottom: 16px;
          position: relative;
        }
    
        .profile-picture-placeholder,
        .profile-picture {
          width: 120px;
          height: 120px;
          border-radius: 15%;
          object-fit: cover;
          border: 3px solid var(--estaco-primary);
          display: none;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
    
        .profile-details {
          margin-bottom: 16px;
        }
    
        .profile-details h2 {
          margin: 0 0 4px 0;
          font-size: 22px;
          font-weight: 600;
          color: var(--estaco-text);
        }
    
        .profile-details p {
          margin: 0;
          color: var(--estaco-text-light);
          font-size: 14px;
        }
    
        .profile-actions {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          gap: 10px;
          margin-top: 8px;
        }
    
        .button {
          padding: 10px 20px;
          background-color: var(--estaco-primary);
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 500;
          transition: all 0.2s ease;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
    
        .button:hover {
          background-color: var(--estaco-primary-light);
          transform: translateY(-1px);
        }
    
        .button.remove {
          background-color: var(--estaco-error);
        }
    
        .button.remove:hover {
          background-color: #d32f2f;
        }
    
        .profile-content {
          background: var(--estaco-surface);
          padding: 20px;
          margin-bottom: 20px;
          border-radius: 12px;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
          border: 1px solid var(--estaco-border);
        }
    
        .section {
          margin-bottom: 24px;
        }
    
        .section h3 {
          margin-top: 0;
          margin-bottom: 12px;
          font-size: 18px;
          font-weight: 600;
          color: var(--estaco-primary);
          border-bottom: 1px solid var(--estaco-border);
          padding-bottom: 8px;
        }
    
        .search-friend {
          display: flex;
          gap: 10px;
          margin-bottom: 20px;
        }
    
        .search-friend input {
          flex: 1;
          padding: 12px;
          border: 1px solid var(--estaco-border);
          border-radius: 8px;
          font-size: 14px;
          transition: border-color 0.2s;
        }
    
        .search-friend input:focus {
          outline: none;
          border-color: var(--estaco-primary);
        }
    
        .friend-list {
          display: flex;
          flex-direction: column;
          gap: 10px;
        }
    
        .friend, .pending-friend {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 12px 16px;
          background: white;
          border-radius: 8px;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
          border: 1px solid var(--estaco-border);
          transition: transform 0.1s;
        }
    
        .friend:hover, .pending-friend:hover {
          transform: translateY(-2px);
        }
    
        .friend-button {
          padding: 6px 12px;
          background-color: var(--estaco-primary);
          color: white;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          font-size: 12px;
          transition: background-color 0.2s;
        }
    
        .friend-button:hover {
          background-color: var(--estaco-primary-light);
        }
    
        .friend-button.remove {
          background-color: var(--estaco-error);
        }
    
        .message {
          padding: 12px;
          margin: 12px 0;
          text-align: center;
          font-size: 14px;
        }
    
        #error-message {
          color: var(--estaco-error);
        }
    
        #success-message {
          color: var(--estaco-success);
        }
    
        #cropper-modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          z-index: 1000;
          align-items: center;
          justify-content: center;
        }
    
        #cropper-modal > div {
          max-width: 90%;
          width: 350px;
          margin: 0;
          background: white;
          padding: 20px;
          border-radius: 12px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
    
        #cropper-modal h3 {
          margin-top: 0;
          color: var(--estaco-primary);
          font-size: 18px;
        }
    
        #crop-done-button, #crop-cancel-button {
          margin-top: 12px;
          width: 100%;
          padding: 10px;
        }
    
        #crop-cancel-button {
          background-color: var(--estaco-error);
          margin-top: 8px;
        }
    
        #bottom-nav-bar {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          display: flex;
          justify-content: space-around;
          align-items: center;
          background-color: var(--estaco-surface);
          border-top: 1px solid var(--estaco-border);
          padding: 10px 0;
          z-index: 100;
          box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.05);
        }
    
        .nav-button {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          background: none;
          border: none;
          cursor: pointer;
          padding: 8px 16px;
          color: var(--estaco-text-light);
          font-size: 12px;
          transition: color 0.2s;
        }
    
        .nav-button.active, .nav-button:hover {
          color: var(--estaco-primary);
        }
    
        .nav-button .icon {
          font-size: 22px;
          margin-bottom: 4px;
        }
    
        .nav-button .label {
          font-size: 12px;
        }
        .rules-container {
          background: var(--estaco-surface);
          padding: 16px;
          border-radius: 8px;
          border: 1px solid var(--estaco-border);
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .rules-container p {
          margin: 8px 0;
          color: var(--estaco-text);
          font-size: 14px;
        }
        
        .rules-container .example {
          margin-top: 12px;
          padding: 12px;
          background: var(--estaco-accent);
          border-radius: 8px;
          border-left: 3px solid var(--estaco-primary);
        }
        
        .rules-container .example p {
          margin: 0;
          font-style: italic;
        }
    </style>

</head>
<body>
      <!-- Top Navigation Bar (optional, for consistency with home page) -->
      <div id="top-nav-bar">
        <h1>Estaco</h1>
      </div>

      <div id="download-app-section" style="margin: 20px auto; text-align: center; max-width: 400px;">
          <button id="download-app-button" style="
          background-color: var(--estaco-accent);
          color: var(--estaco-text);
          border: none;
          border-radius: 8px;
          padding: 12px;
          font-weight: 500;
          cursor: pointer;
          transition: background-color 0.3s;
          width: 100%;
        ">
          Download the App
        </button>
        <div id="install-guide" style="display: none; margin-top: 20px; text-align: left; background-color: var(--estaco-surface); padding: 20px; border-radius: 12px;">
          <h3 style="color: var(--estaco-primary);">How to Install the App</h3>
          <p><strong>Android:</strong></p>
          <ol>
            <li>Tap the <strong>three dots (‚ãÆ)</strong> in the top-right corner of your browser.</li>
            <li>Select <strong>"Add to Home screen"</strong>.</li>
            <li>Tap <strong>"Add"</strong> to confirm.</li>
          </ol>
          <p><strong>iPhone (iOS):</strong></p>
          <ol>
            <li>Tap the <strong>Share button (‚Üë)</strong> at the bottom of your screen.</li>
            <li>Scroll down and select <strong>"Add to Home Screen"</strong>.</li>
            <li>Tap <strong>"Add"</strong> to confirm.</li>
          </ol>
          <p style="font-size: 14px; color: var(--estaco-text-light);">The app will now appear on your home screen like a normal app!</p>
        </div>
      </div>
    
      <!-- Profile Header -->
      <div class="profile-header">
        <div class="profile-picture-container">
          <div id="profile-picture-placeholder" class="profile-picture-placeholder"></div>
          <img id="profile-picture" src="" alt="Profile Picture" class="profile-picture">
        </div>
        <div class="profile-details">
          <h2 id="user-name">User Name</h2>
          <p id="user-email">user@example.com</p>
        </div>
        <div class="profile-actions">
          <button id="update-profile-pic-button" class="button">Update Profile Picture</button>
          <button id="change-password-button" class="button">Change Password</button>
          <button id="logout-button" class="button">Log Out</button>
        </div>
      </div>
    
      <div class="section">
        <h3>Platform Rules</h3>
        <div class="rules-container">
          <p><strong>1.</strong> Max 15 friends.</p>
          <p><strong>2.</strong> Your posts are not visible to users who are not your friends.</p>
          <p><strong>3.</strong> Your comments and reactions are not visible to users who are not your friends.</p>
          <div class="example">
            <p><strong>Example:</strong> John is friends with Mike but not with Jenny. Mike is friends with Jenny. If Jenny comments on Mike's post, John will see Mike's post but not Jenny's comment.</p>
          </div>
        </div>
      </div>
    
      <!-- Profile Content -->
      <div class="profile-content">
        <div class="section">
          <h3>Friend System</h3>
          <div class="search-friend">
            <input type="text" id="search-friend" placeholder="Search by name...">
            <button id="send-friend-request" class="button">Send Friend Request</button>
          </div>
        </div>
    
        <div class="section">
          <h3>Pending Friend Requests</h3>
          <div id="pending-friend-requests" class="friend-list"></div>
        </div>
    
        <div class="section">
          <h3>Current Friends</h3>
          <div id="current-friends" class="friend-list"></div>
        </div>
      </div>
    
      <!-- Cropper Modal -->
      <div id="cropper-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
        <div style="max-width: 500px; margin: 20px auto; background: white; padding: 20px; border-radius: 10px;">
          <h3>Crop Profile Picture</h3>
          <div style="width: 100%; height: 400px;">
            <img id="cropper-image" style="max-width: 100%;">
          </div>
          <button id="crop-done-button" class="button" style="margin-top: 10px;">Crop and Upload</button>
          <button id="crop-cancel-button" class="button" style="margin-top: 10px; background-color: #f44336;">Cancel</button>
        </div>
      </div>
    
      <input type="file" id="update-profile-pic" accept="image/*" style="display: none;">
      <p id="error-message" class="message"></p>
      <p id="success-message" class="message"></p>

      <div id="bottom-nav-bar">
          <button class="nav-button" id="home-button">
            <span class="icon">üè†</span>
            <span class="label">Feed</span>
          </button>
          <button class="nav-button" id="profile-button">
            <span class="icon">üë§</span>
            <span class="label">Profile</span>
          </button>
      </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script>
        // Your Firebase config (replace with your own)
        const firebaseConfig = {
            apiKey: "AIzaSyB1txjASKb_6VPhKBpQh_Y3hoPHsNWwZ_0",
            authDomain: "estaco-add3c.firebaseapp.com",
            projectId: "estaco-add3c",
            storageBucket: "estaco-add3c.firebasestorage.app",
            messagingSenderId: "876337002297",
            appId: "1:876337002297:web:b410c373bd857bc7cd1ae8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const storage = firebase.storage();
        const db = firebase.firestore();

        // DOM Elements
        const searchFriendInput = document.getElementById('search-friend');
        const sendFriendRequestButton = document.getElementById('send-friend-request');
        const pendingFriendRequestsDiv = document.getElementById('pending-friend-requests');
        const currentFriendsDiv = document.getElementById('current-friends');

        // Load friends and requests on page load
        auth.onAuthStateChanged(user => {
            if (user) {
                loadPendingRequests(user.uid);
                loadCurrentFriends(user.uid);
            }
        });

        // Load pending friend requests
        function loadPendingRequests(userId) {
            db.collection('friendRequests').where('to', '==', userId).get()
                .then(snapshot => {
                    pendingFriendRequestsDiv.innerHTML = '';
                    const promises = [];
                    snapshot.forEach(doc => {
                        const request = doc.data();
                        const promise = db.collection('users').doc(request.from).get()
                            .then(userDoc => {
                                const fromName = userDoc.data().name;
                                const requestDiv = document.createElement('div');
                                requestDiv.className = 'pending-friend';
                                requestDiv.innerText = fromName;
                                const acceptButton = document.createElement('button');
                                acceptButton.className = 'friend-button';
                                acceptButton.innerText = 'Accept';
                                acceptButton.onclick = () => acceptFriendRequest(request.from, userId);
                                requestDiv.appendChild(acceptButton);
                                pendingFriendRequestsDiv.appendChild(requestDiv);
                            });
                        promises.push(promise);
                    });
                    return Promise.all(promises);
                });
        }

        // Load current friends
        function loadCurrentFriends(userId) {
            db.collection('friends').doc(userId).get()
                .then(doc => {
                    const friends = doc.data()?.friends || [];
                    currentFriendsDiv.innerHTML = '';
                    friends.forEach(friend => {
                        const friendDiv = document.createElement('div');
                        friendDiv.className = 'friend';
                        friendDiv.innerText = friend.name;
                        // Add a "Remove" button
                        const removeButton = document.createElement('button');
                        removeButton.className = 'friend-button remove';
                        removeButton.innerText = 'Remove';
                        removeButton.onclick = () => removeFriend(userId, friend.uid);
                        friendDiv.appendChild(removeButton);
                        currentFriendsDiv.appendChild(friendDiv);
                    });
                });
        }

        // Send friend request
        sendFriendRequestButton.addEventListener('click', () => {
            const friendName = searchFriendInput.value.trim();
            if (friendName) {
                const user = auth.currentUser;
                if (!user) return;
        
                // Check if the user already has 15 friends
                db.collection('friends').doc(user.uid).get()
                    .then((doc) => {
                        const friends = doc.data()?.friends || [];
                        if (friends.length >= 15) {
                            alert('You have reached the maximum number of friends (15).');
                            return;
                        }
        
                        // Proceed with sending the friend request
                        db.collection('users').where('name', '==', friendName).get()
                            .then(snapshot => {
                                if (!snapshot.empty) {
                                    const friendDoc = snapshot.docs[0];
                                    const friendUser = friendDoc.data();
                                    const friendUid = friendDoc.id;
                                    sendRequest(user.uid, friendUid, friendUser.name);
                                } else {
                                    alert('User not found');
                                }
                            })
                            .catch(error => {
                                console.error('Error searching for user: ', error);
                                alert('An error occurred while searching for the user.');
                            });
                    });
            } else {
                alert('Please enter a name to search');
            }
        });

        // Function to send friend request
        function sendRequest(fromId, toId, fromName) {
            if (!toId) {
                console.error('Cannot send friend request: toId is undefined.');
                return;
            }
            db.collection('friendRequests').add({
                from: fromId,
                to: toId,
                fromName: fromName,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                alert('Friend request sent!');
            }).catch(error => {
                console.error('Error sending friend request: ', error);
                alert('Failed to send friend request.');
            });
        }

        // Accept friend request
        function acceptFriendRequest(fromId, toId) {
            // Check if the user already has 15 friends
            db.collection('friends').doc(toId).get()
                .then((doc) => {
                    const friends = doc.data()?.friends || [];
                    if (friends.length >= 15) {
                        alert('You have reached the maximum number of friends (15).');
                        return;
                    }
        
                    // Proceed with accepting the friend request
                    db.collection('users').doc(fromId).get()
                        .then(fromUserDoc => {
                            const fromName = fromUserDoc.data().name;
                            db.collection('users').doc(toId).get()
                                .then(toUserDoc => {
                                    const toName = toUserDoc.data().name;
                                    db.collection('friends').doc(toId).set({
                                        friends: firebase.firestore.FieldValue.arrayUnion({ uid: fromId, name: fromName }),
                                        friendsList: firebase.firestore.FieldValue.arrayUnion(fromId)
                                    }, { merge: true });
                                    db.collection('friends').doc(fromId).set({
                                        friends: firebase.firestore.FieldValue.arrayUnion({ uid: toId, name: toName }),
                                        friendsList: firebase.firestore.FieldValue.arrayUnion(toId)
                                    }, { merge: true });
                                    db.collection('friendRequests').where('from', '==', fromId).where('to', '==', toId).get()
                                        .then(snapshot => {
                                            snapshot.forEach(doc => {
                                                doc.ref.delete();
                                            });
                                            const pendingRequests = document.querySelectorAll('.pending-friend');
                                            pendingRequests.forEach(requestDiv => {
                                                if (requestDiv.textContent.includes(fromName)) {
                                                    requestDiv.remove();
                                                }
                                            });
                                            alert('Friend request accepted!');
                                            loadCurrentFriends(toId);
                                        });
                                });
                        });
                });
        }

        function removeFriend(userId, friendUid) {
            // Ask for confirmation
            const confirmRemove = confirm("Are you sure you want to remove this friend?");
            if (!confirmRemove) {
                return; // Do nothing if the user cancels
            }
        
            // Fetch the friend's name and the user's name in parallel
            Promise.all([
                db.collection('users').doc(friendUid).get(),
                db.collection('users').doc(userId).get()
            ])
            .then(([friendDoc, userDoc]) => {
                if (friendDoc.exists && userDoc.exists) {
                    const friendName = friendDoc.data().name;
                    const userName = userDoc.data().name;
        
                    // Update both `friends` and `friendsList` for both users
                    const userFriendsUpdate = db.collection('friends').doc(userId).update({
                        friends: firebase.firestore.FieldValue.arrayRemove({ uid: friendUid, name: friendName }),
                        friendsList: firebase.firestore.FieldValue.arrayRemove(friendUid)
                    });
        
                    const friendFriendsUpdate = db.collection('friends').doc(friendUid).update({
                        friends: firebase.firestore.FieldValue.arrayRemove({ uid: userId, name: userName }),
                        friendsList: firebase.firestore.FieldValue.arrayRemove(userId)
                    });
        
                    // Wait for both updates to complete
                    Promise.all([userFriendsUpdate, friendFriendsUpdate])
                        .then(() => {
                            // Reload the friend list
                            loadCurrentFriends(userId);
                        })
                        .catch((error) => {
                            console.error("Error updating friends lists: ", error);
                            alert("Failed to update friends lists.");
                        });
                } else {
                    console.error("User or friend document does not exist.");
                    alert("Failed to remove friend: user or friend not found.");
                }
            })
            .catch((error) => {
                console.error("Error fetching user or friend data: ", error);
                alert("Failed to remove friend.");
            });
        }

        // Display user information
        auth.onAuthStateChanged((user) => {
          if (user) {
            document.getElementById('user-name').textContent = user.displayName || "No name set";
            document.getElementById('user-email').textContent = user.email;
        
            // Load user data from Firestore
            db.collection('users').doc(user.uid).get()
              .then((doc) => {
                const placeholder = document.getElementById('profile-picture-placeholder');
                const img = document.getElementById('profile-picture');
        
                if (doc.exists) {
                  const userData = doc.data();
                  if (userData.profilePictureURL) {
                    img.src = userData.profilePictureURL;
                    img.style.display = 'block';
                    placeholder.style.display = 'none';
                  } else {
                    // No profile picture, show initials fallback
                    placeholder.innerHTML = getInitialsFallback(user.displayName || "No name set");
                    placeholder.style.display = 'block';
                    img.style.display = 'none';
                  }
                } else {
                  // No user data, show initials fallback
                  placeholder.innerHTML = getInitialsFallback(user.displayName || "No name set");
                  placeholder.style.display = 'block';
                  img.style.display = 'none';
                }
              })
              .catch((error) => {
                console.error("Error loading user data:", error);
              });
          }
        });
        
        // Upload profile picture
        document.getElementById('update-profile-pic-button').addEventListener('click', () => {
          const fileInput = document.getElementById('update-profile-pic');
          fileInput.click();
        });
        
        let cropper;
        document.getElementById('update-profile-pic').addEventListener('change', (event) => {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              const modal = document.getElementById('cropper-modal');
              const cropperImage = document.getElementById('cropper-image');
              cropperImage.src = e.target.result;
              modal.style.display = 'block';
        
              // Initialize Cropper.js
              cropper = new Cropper(cropperImage, {
                aspectRatio: 1, // Square aspect ratio
                viewMode: 1,
                dragMode: 'move',
                guides: true,
                highlight: false,
                cropBoxMovable: true,
                cropBoxResizable: true,
                modal: true,
              });
            };
            reader.readAsDataURL(file);
          }
        });

        function getInitialsFallback(name) {
          const firstLetter = name.charAt(0).toUpperCase();
          const pastelColors = ['#FFD1DC', '#FFE4B5', '#B5EAD7', '#C7CEEA', '#E2F0CB', '#FFB7B2'];
          const colorIndex = name.charCodeAt(0) % pastelColors.length;
          const backgroundColor = pastelColors[colorIndex];
          return `
            <div style="
              width: 120px;
              height: 120px;
              border-radius: 15%;
              background-color: ${backgroundColor};
              display: flex;
              align-items: center;
              justify-content: center;
              color: #333;
              font-weight: bold;
              font-size: 40px;
            ">
              ${firstLetter}
            </div>
          `;
        }
        
        // Handle crop done
        document.getElementById('crop-done-button').addEventListener('click', () => {
          if (cropper) {
            const canvas = cropper.getCroppedCanvas({
              width: 200,
              height: 200,
              fillColor: '#fff',
              imageSmoothingEnabled: true,
              imageSmoothingQuality: 'high',
            });
            if (canvas) {
              canvas.toBlob((blob) => {
                const user = auth.currentUser;
                const storageRef = storage.ref();
                const profilePicRef = storageRef.child(`profilePictures/${user.uid}`);
                const uploadTask = profilePicRef.put(blob);
        
                uploadTask.on('state_changed',
                  null,
                  (error) => {
                    console.error('Upload error:', error);
                    document.getElementById('error-message').textContent = 'Failed to upload profile picture.';
                  },
                  () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                      db.collection('users').doc(user.uid).update({
                        profilePictureURL: downloadURL
                      }).then(() => {
                        document.getElementById('profile-picture').src = downloadURL;
                        document.getElementById('success-message').textContent = 'Profile picture updated!';
                        document.getElementById('cropper-modal').style.display = 'none';
                        cropper.destroy();
                      });
                    });
                  }
                );
              }, 'image/jpeg');
            }
          }
        });
        
        // Handle cancel
        document.getElementById('crop-cancel-button').addEventListener('click', () => {
          document.getElementById('cropper-modal').style.display = 'none';
          if (cropper) {
            cropper.destroy();
          }
        });

        // Change Password
        document.getElementById('change-password-button').addEventListener('click', () => {
            const currentPassword = prompt('Enter your current password:');
            if (currentPassword) {
                const user = auth.currentUser;
                const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
                user.reauthenticateWithCredential(credential).then(() => {
                    const newPassword = prompt('Enter your new password (at least 6 characters):');
                    const confirmPassword = prompt('Confirm your new password:');

                    if (newPassword && confirmPassword && newPassword === confirmPassword && newPassword.length >= 6) {
                        user.updatePassword(newPassword).then(() => {
                            document.getElementById('success-message').textContent = 'Password updated successfully!';
                            document.getElementById('error-message').textContent = '';
                        }).catch((error) => {
                            document.getElementById('error-message').textContent = error.message;
                            document.getElementById('success-message').textContent = '';
                        });
                    } else {
                        alert('Passwords do not match or are too short. Please try again.');
                    }
                }).catch((error) => {
                    document.getElementById('error-message').textContent = 'Current password is incorrect.';
                    document.getElementById('success-message').textContent = '';
                });
            }
        });

        // Log Out
        document.getElementById('logout-button').addEventListener('click', () => {
          const confirmLogout = confirm('Are you sure you want to log out?');
          if (confirmLogout) {
            auth.signOut().then(() => {
              alert('You have been logged out.');
              window.location.href = 'index.html';
            }).catch((error) => {
              document.getElementById('error-message').textContent = error.message;
            });
          }
        });

        // Navigate to Home
        document.getElementById('home-button').addEventListener('click', () => {
          window.location.href = 'home.html';
        });
        
        // Navigate to Profile (optional, since you're already on the profile page)
        document.getElementById('profile-button').addEventListener('click', () => {
          window.location.href = 'profile.html';
        });

        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
              .then((registration) => {
                console.log('ServiceWorker registration successful');
              })
              .catch((err) => {
                console.log('ServiceWorker registration failed: ', err);
              });
          });
        }

        const downloadAppButton = document.getElementById('download-app-button');
        const installGuide = document.getElementById('install-guide');
        
        downloadAppButton.addEventListener('click', () => {
          if (installGuide.style.display === 'none') {
            installGuide.style.display = 'block';
            downloadAppButton.textContent = 'Hide Guide';
          } else {
            installGuide.style.display = 'none';
            downloadAppButton.textContent = 'Download the App';
          }
        });
    </script>
</body>
</html>
