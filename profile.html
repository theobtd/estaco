<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <title>Estaco - Profile</title>
    <style>
        body {
          font-family: Arial, sans-serif;
          margin: 0;
          padding: 0;
          padding-top: 60px; /* Space for top nav bar */
          padding-bottom: 60px; /* Space for bottom nav bar */
          background-color: #f9f9f9;
        }
        
        #top-nav-bar {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          display: flex;
          justify-content: center;
          align-items: center;
          background-color: white;
          border-bottom: 1px solid #e0e0e0;
          padding: 10px 0;
          z-index: 100;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        #top-nav-bar h1 {
          margin: 0;
          font-size: 24px;
          color: #1877f2;
        }
        
        .profile-header {
          background: white;
          padding: 20px;
          margin-bottom: 20px;
          border-radius: 8px;
          box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
          display: flex;
          flex-direction: column;
          align-items: center;
          text-align: center;
        }
        
        .profile-picture-container {
          margin-bottom: 15px;
        }
        
        .profile-picture-placeholder,
        .profile-picture {
          width: 120px;
          height: 120px;
          border-radius: 50%;
          object-fit: cover;
          border: 3px solid #1877f2;
        }
        
        .profile-details {
          margin-bottom: 15px;
        }
        
        .profile-details h2 {
          margin: 0;
          font-size: 24px;
        }
        
        .profile-details p {
          margin: 5px 0;
          color: #666;
        }
        
        .profile-actions {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          gap: 10px;
        }
        
        .button {
          padding: 8px 16px;
          background-color: #1877f2;
          color: white;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          font-size: 14px;
          transition: background-color 0.2s;
        }
        
        .button:hover {
          background-color: #166fe5;
        }
        
        .button.remove {
          background-color: #f44336;
        }
        
        .button.remove:hover {
          background-color: #d32f2f;
        }
        
        .profile-content {
          background: white;
          padding: 20px;
          margin-bottom: 20px;
          border-radius: 8px;
          box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .section {
          margin-bottom: 20px;
        }
        
        .section h3 {
          margin-top: 0;
          border-bottom: 1px solid #eee;
          padding-bottom: 10px;
        }
        
        .search-friend {
          display: flex;
          gap: 10px;
          margin-bottom: 20px;
        }
        
        .search-friend input {
          flex: 1;
          padding: 10px;
          border: 1px solid #ddd;
          border-radius: 6px;
        }
        
        .friend-list {
          display: flex;
          flex-direction: column;
          gap: 10px;
        }
        
        .friend, .pending-friend {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 10px;
          background: #f9f9f9;
          border-radius: 6px;
        }
        
        .message {
          padding: 10px;
          margin: 10px 0;
          text-align: center;
        }
        
        #error-message {
          color: red;
        }
        
        #success-message {
          color: green;
        }

    </style>
</head>
<body>
      <!-- Top Navigation Bar (optional, for consistency with home page) -->
      <div id="top-nav-bar">
        <h1>Estaco</h1>
      </div>
    
      <!-- Profile Header -->
      <div class="profile-header">
        <div class="profile-picture-container">
          <div id="profile-picture-placeholder" class="profile-picture-placeholder"></div>
          <img id="profile-picture" src="" alt="Profile Picture" class="profile-picture">
        </div>
        <div class="profile-details">
          <h2 id="user-name">User Name</h2>
          <p id="user-email">user@example.com</p>
        </div>
        <div class="profile-actions">
          <button id="update-profile-pic-button" class="button">Update Profile Picture</button>
          <button id="change-password-button" class="button">Change Password</button>
          <button id="logout-button" class="button">Log Out</button>
          <button id="back-to-home-button" class="button">Back to Home</button>
        </div>
      </div>
    
      <!-- Profile Content -->
      <div class="profile-content">
        <div class="section">
          <h3>Friend System</h3>
          <div class="search-friend">
            <input type="text" id="search-friend" placeholder="Search by name...">
            <button id="send-friend-request" class="button">Send Friend Request</button>
          </div>
        </div>
    
        <div class="section">
          <h3>Pending Friend Requests</h3>
          <div id="pending-friend-requests" class="friend-list"></div>
        </div>
    
        <div class="section">
          <h3>Current Friends</h3>
          <div id="current-friends" class="friend-list"></div>
        </div>
      </div>
    
      <!-- Cropper Modal -->
      <div id="cropper-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
        <div style="max-width: 500px; margin: 20px auto; background: white; padding: 20px; border-radius: 10px;">
          <h3>Crop Profile Picture</h3>
          <div style="width: 100%; height: 400px;">
            <img id="cropper-image" style="max-width: 100%;">
          </div>
          <button id="crop-done-button" class="button" style="margin-top: 10px;">Crop and Upload</button>
          <button id="crop-cancel-button" class="button" style="margin-top: 10px; background-color: #f44336;">Cancel</button>
        </div>
      </div>
    
      <input type="file" id="update-profile-pic" accept="image/*" style="display: none;">
      <p id="error-message" class="message"></p>
      <p id="success-message" class="message"></p>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script>
        // Your Firebase config (replace with your own)
        const firebaseConfig = {
            apiKey: "AIzaSyB1txjASKb_6VPhKBpQh_Y3hoPHsNWwZ_0",
            authDomain: "estaco-add3c.firebaseapp.com",
            projectId: "estaco-add3c",
            storageBucket: "estaco-add3c.firebasestorage.app",
            messagingSenderId: "876337002297",
            appId: "1:876337002297:web:b410c373bd857bc7cd1ae8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const storage = firebase.storage();
        const db = firebase.firestore();

        // DOM Elements
        const searchFriendInput = document.getElementById('search-friend');
        const sendFriendRequestButton = document.getElementById('send-friend-request');
        const pendingFriendRequestsDiv = document.getElementById('pending-friend-requests');
        const currentFriendsDiv = document.getElementById('current-friends');

        // Load friends and requests on page load
        auth.onAuthStateChanged(user => {
            if (user) {
                loadPendingRequests(user.uid);
                loadCurrentFriends(user.uid);
            }
        });

        // Load pending friend requests
        function loadPendingRequests(userId) {
            db.collection('friendRequests').where('to', '==', userId).get()
                .then(snapshot => {
                    pendingFriendRequestsDiv.innerHTML = '';
                    const promises = [];
                    snapshot.forEach(doc => {
                        const request = doc.data();
                        const promise = db.collection('users').doc(request.from).get()
                            .then(userDoc => {
                                const fromName = userDoc.data().name;
                                const requestDiv = document.createElement('div');
                                requestDiv.className = 'pending-friend';
                                requestDiv.innerText = fromName;
                                const acceptButton = document.createElement('button');
                                acceptButton.className = 'friend-button';
                                acceptButton.innerText = 'Accept';
                                acceptButton.onclick = () => acceptFriendRequest(request.from, userId);
                                requestDiv.appendChild(acceptButton);
                                pendingFriendRequestsDiv.appendChild(requestDiv);
                            });
                        promises.push(promise);
                    });
                    return Promise.all(promises);
                });
        }

        // Load current friends
        function loadCurrentFriends(userId) {
            db.collection('friends').doc(userId).get()
                .then(doc => {
                    const friends = doc.data()?.friends || [];
                    currentFriendsDiv.innerHTML = '';
                    friends.forEach(friend => {
                        const friendDiv = document.createElement('div');
                        friendDiv.className = 'friend';
                        friendDiv.innerText = friend.name;
                        // Add a "Remove" button
                        const removeButton = document.createElement('button');
                        removeButton.className = 'friend-button remove';
                        removeButton.innerText = 'Remove';
                        removeButton.onclick = () => removeFriend(userId, friend.uid);
                        friendDiv.appendChild(removeButton);
                        currentFriendsDiv.appendChild(friendDiv);
                    });
                });
        }

        // Send friend request
        sendFriendRequestButton.addEventListener('click', () => {
            const friendName = searchFriendInput.value.trim();
            if (friendName) {
                console.log(`Searching for user with name: ${friendName}`); // Log the search name
                db.collection('users').where('name', '==', friendName).get()
                    .then(snapshot => {
                        if (!snapshot.empty) {
                            const friendDoc = snapshot.docs[0];
                            const friendUser = friendDoc.data();
                            const friendUid = friendDoc.id; // <-- This is the UID!
                            sendRequest(auth.currentUser.uid, friendUid, friendUser.name);
                        } else {
                            alert('User not found');
                        }
                    })
                    .catch(error => {
                        console.error('Error searching for user: ', error);
                        alert('An error occurred while searching for the user.');
                    });
            } else {
                alert('Please enter a name to search');
            }
        });

        // Function to send friend request
        function sendRequest(fromId, toId, fromName) {
            if (!toId) {
                console.error('Cannot send friend request: toId is undefined.');
                return;
            }
            db.collection('friendRequests').add({
                from: fromId,
                to: toId,
                fromName: fromName,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                alert('Friend request sent!');
            }).catch(error => {
                console.error('Error sending friend request: ', error);
                alert('Failed to send friend request.');
            });
        }

        // Accept friend request
        function acceptFriendRequest(fromId, toId) {
            // Fetch the name of the user sending the request
            db.collection('users').doc(fromId).get()
                .then(fromUserDoc => {
                    const fromName = fromUserDoc.data().name;
                    // Fetch the name of the current user
                    db.collection('users').doc(toId).get()
                        .then(toUserDoc => {
                            const toName = toUserDoc.data().name;
                            // Add the friend to both users' friend lists
                            db.collection('friends').doc(toId).set({
                                friends: firebase.firestore.FieldValue.arrayUnion({ uid: fromId, name: fromName })
                            }, { merge: true });
                            db.collection('friends').doc(fromId).set({
                                friends: firebase.firestore.FieldValue.arrayUnion({ uid: toId, name: toName })
                            }, { merge: true });
                            // Remove the friend request
                            db.collection('friendRequests').where('from', '==', fromId).where('to', '==', toId).get()
                                .then(snapshot => {
                                    snapshot.forEach(doc => {
                                        doc.ref.delete();
                                    });
                                    // Remove the accepted request from the DOM
                                    const pendingRequests = document.querySelectorAll('.pending-friend');
                                    pendingRequests.forEach(requestDiv => {
                                        if (requestDiv.textContent.includes(fromName)) {
                                            requestDiv.remove();
                                        }
                                    });
                                    alert('Friend request accepted!');
                                    loadCurrentFriends(toId);
                                });
                        });
                });
        }

        function removeFriend(userId, friendUid) {
            // Ask for confirmation
            const confirmRemove = confirm("Are you sure you want to remove this friend?");
            if (!confirmRemove) {
                return; // Do nothing if the user cancels
            }
        
            // Fetch the friend's name
            db.collection('users').doc(friendUid).get()
                .then((friendDoc) => {
                    if (friendDoc.exists) {
                        const friendName = friendDoc.data().name;
                        // Remove friend from current user's friend list
                        db.collection('friends').doc(userId).update({
                            friends: firebase.firestore.FieldValue.arrayRemove({ uid: friendUid, name: friendName })
                        });
                        // Remove current user from friend's friend list
                        db.collection('users').doc(userId).get()
                            .then((userDoc) => {
                                const userName = userDoc.data().name;
                                db.collection('friends').doc(friendUid).update({
                                    friends: firebase.firestore.FieldValue.arrayRemove({ uid: userId, name: userName })
                                });
                                // Reload the friend list
                                loadCurrentFriends(userId);
                            });
                    }
                })
                .catch((error) => {
                    console.error("Error removing friend: ", error);
                    alert("Failed to remove friend.");
                });
        }

        // Display user information
        auth.onAuthStateChanged((user) => {
          if (user) {
            document.getElementById('user-name').textContent = user.displayName || "No name set";
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('user-password').textContent = "******";
        
            // Load user data from Firestore
            db.collection('users').doc(user.uid).get()
              .then((doc) => {
                if (doc.exists) {
                  const userData = doc.data();
                  const placeholder = document.getElementById('profile-picture-placeholder');
                  const img = document.getElementById('profile-picture');
                  if (userData.profilePictureURL) {
                    img.src = userData.profilePictureURL;
                    img.onload = function() {
                      placeholder.style.display = 'none';
                      img.style.display = 'block';
                    };
                  } else {
                    // No profile picture, show initials fallback
                    placeholder.innerHTML = getInitialsFallback(user.displayName || "No name set");
                  }
                }
              });
          }
        });
        
        // Upload profile picture
        document.getElementById('update-profile-pic-button').addEventListener('click', () => {
          const fileInput = document.getElementById('update-profile-pic');
          fileInput.click();
        });
        
        let cropper;
        document.getElementById('update-profile-pic').addEventListener('change', (event) => {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              const modal = document.getElementById('cropper-modal');
              const cropperImage = document.getElementById('cropper-image');
              cropperImage.src = e.target.result;
              modal.style.display = 'block';
        
              // Initialize Cropper.js
              cropper = new Cropper(cropperImage, {
                aspectRatio: 1, // Square aspect ratio
                viewMode: 1,
                dragMode: 'move',
                guides: true,
                highlight: false,
                cropBoxMovable: true,
                cropBoxResizable: true,
                modal: true,
              });
            };
            reader.readAsDataURL(file);
          }
        });

        function getInitialsFallback(name) {
          const firstLetter = name.charAt(0).toUpperCase();
          const pastelColors = ['#FFD1DC', '#FFE4B5', '#B5EAD7', '#C7CEEA', '#E2F0CB', '#FFB7B2'];
          const colorIndex = name.charCodeAt(0) % pastelColors.length;
          const backgroundColor = pastelColors[colorIndex];
          return `
            <div style="
              width: 100px;
              height: 100px;
              border-radius: 15%;
              background-color: ${backgroundColor};
              display: flex;
              align-items: center;
              justify-content: center;
              color: #333;
              font-weight: bold;
              font-size: 40px;
              margin-right: 10px;
            ">
              ${firstLetter}
            </div>
          `;
        }
        
        // Handle crop done
        document.getElementById('crop-done-button').addEventListener('click', () => {
          if (cropper) {
            const canvas = cropper.getCroppedCanvas({
              width: 200,
              height: 200,
              fillColor: '#fff',
              imageSmoothingEnabled: true,
              imageSmoothingQuality: 'high',
            });
            if (canvas) {
              canvas.toBlob((blob) => {
                const user = auth.currentUser;
                const storageRef = storage.ref();
                const profilePicRef = storageRef.child(`profilePictures/${user.uid}`);
                const uploadTask = profilePicRef.put(blob);
        
                uploadTask.on('state_changed',
                  null,
                  (error) => {
                    console.error('Upload error:', error);
                    document.getElementById('error-message').textContent = 'Failed to upload profile picture.';
                  },
                  () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                      db.collection('users').doc(user.uid).update({
                        profilePictureURL: downloadURL
                      }).then(() => {
                        document.getElementById('profile-picture').src = downloadURL;
                        document.getElementById('success-message').textContent = 'Profile picture updated!';
                        document.getElementById('cropper-modal').style.display = 'none';
                        cropper.destroy();
                      });
                    });
                  }
                );
              }, 'image/jpeg');
            }
          }
        });
        
        // Handle cancel
        document.getElementById('crop-cancel-button').addEventListener('click', () => {
          document.getElementById('cropper-modal').style.display = 'none';
          if (cropper) {
            cropper.destroy();
          }
        });

        // Change Password
        document.getElementById('change-password-button').addEventListener('click', () => {
            const currentPassword = prompt('Enter your current password:');
            if (currentPassword) {
                const user = auth.currentUser;
                const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
                user.reauthenticateWithCredential(credential).then(() => {
                    const newPassword = prompt('Enter your new password (at least 6 characters):');
                    const confirmPassword = prompt('Confirm your new password:');

                    if (newPassword && confirmPassword && newPassword === confirmPassword && newPassword.length >= 6) {
                        user.updatePassword(newPassword).then(() => {
                            document.getElementById('success-message').textContent = 'Password updated successfully!';
                            document.getElementById('error-message').textContent = '';
                        }).catch((error) => {
                            document.getElementById('error-message').textContent = error.message;
                            document.getElementById('success-message').textContent = '';
                        });
                    } else {
                        alert('Passwords do not match or are too short. Please try again.');
                    }
                }).catch((error) => {
                    document.getElementById('error-message').textContent = 'Current password is incorrect.';
                    document.getElementById('success-message').textContent = '';
                });
            }
        });

        // Back to Home
        document.getElementById('back-to-home-button').addEventListener('click', () => {
            window.location.href = 'home.html';
        });

        // Log Out
        document.getElementById('logout-button').addEventListener('click', () => {
          const confirmLogout = confirm('Are you sure you want to log out?');
          if (confirmLogout) {
            auth.signOut().then(() => {
              alert('You have been logged out.');
              window.location.href = 'index.html';
            }).catch((error) => {
              document.getElementById('error-message').textContent = error.message;
            });
          }
        });
    </script>
</body>
</html>
